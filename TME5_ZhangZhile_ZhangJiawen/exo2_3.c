#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <unistd.h>
#include <sys/wait.h>
#include <sys/times.h>

#define MAX_CMD_LENGTH 100

int main() {
    char cmd[MAX_CMD_LENGTH];

    while (1) {
        printf("Entrez une commande (quit pour quitter) : ");
        fgets(cmd, MAX_CMD_LENGTH, stdin);

        // retirer le '\n' à la fin de la commande
        cmd[strcspn(cmd, "\n")] = 0;

        if (strcmp(cmd, "quit") == 0) {
            break;
        }

        pid_t pid = fork();

        if (pid == -1) {
            perror("echou");
            exit(EXIT_FAILURE);
        } else if (pid == 0) {
            // processus fils
            struct tms t1, t2;
            times(&t1);

            char* token = strtok(cmd, " ");
            char* args[MAX_CMD_LENGTH];
            int i = 0;

            while (token != NULL) {
                args[i++] = token;
                token = strtok(NULL, " ");
            }

            args[i] = NULL;

            execvp(args[0], args);

            // si on arrive ici, l'execution a échoué
            perror("echou");
            exit(EXIT_FAILURE);
        } else {
            // processus parent
            if (cmd[strlen(cmd) - 1] != '&') {
                // attendre la fin du processus fils si '&' n'est pas à la fin de la commande
                waitpid(pid, NULL, 0);

                struct tms t1, t2;
                times(&t2);

                printf("Temps d'exécution : %ld ms\n", (t2.tms_utime - t1.tms_utime) * 1000 / sysconf(_SC_CLK_TCK));
            }
        }
    }

    return 0;
}
